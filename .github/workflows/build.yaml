# Copyright 2022 The Trax Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: build

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        python-version: [ '3.10' ]
        # Which tf-version run.
        tf-version: [ '2.17.0' ]
        # Which set of tests to run.
        trax-test: [ 'lib','research' ]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      - name: Set up Python ${{matrix.python-version}}
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.python-version}}
          cache: 'pip'
      - name: Install dependencies
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: '1'
        run: |
          python -m pip install -U pip
          # Install TensorFlow matching matrix version.
          python -m pip install "tensorflow==${{ matrix.tf-version }}"
          # Install package in editable mode with test and T5 extras (tests use T5 preprocessors).
          python -m pip install -e .[tests,t5,rl]
      # Test out right now with only testing one directory.
      - name: Install trax package
        run: |
          python -m pip install -e .
      - name: Test with pytest
        working-directory: .
        run: |
          TRAX_TEST="${{matrix.trax-test}}" ./oss_scripts/oss_tests.sh
      # The below step just reports the success or failure of tests as a "commit status".
      # This is needed for copy bara integration.
      - name: Report success or failure as github status
        if: always()
        shell: bash
        run: |
          status="${{ job.status }}"
          lowercase_status=$(echo $status | tr '[:upper:]' '[:lower:]')
          curl -sS --request POST \
          --url https://api.github.com/repos/${{github.repository}}/statuses/${{github.sha}} \
          --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
          --header 'content-type: application/json' \
          --data '{
              "state": "'$lowercase_status'",
              "target_url": "https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}",
              "description": "'$status'",
              "context": "github-actions/build"
              }'
